<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Virtual machines: configure, share and automate</title><meta content="<p>Creating and using virtual machines is 
pretty easy with Vagrant, VirtualBox and
Ansible.</p>
" name=description><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link color=#000000 href=/img/safari-pinned-tab.svg rel=mask-icon><meta content=#da532c name=msapplication-TileColor><meta content=#000000 name=theme-color><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Jost&display=swap" rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css rel=stylesheet><link href=/css/var.css rel=stylesheet><link href=/css/base.css rel=stylesheet><link href=/css/header.css rel=stylesheet><link href=/css/footer.css rel=stylesheet><link href=/css/post.css rel=stylesheet><body><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark-mode')}</script><header class=blur><div class=top><a class="header blog" href=/blog><i class="ri-quill-pen-line ri-2x"></i><span>Blog</span></a><a class=back href=/><i class="ri-arrow-left-s-line ri-1x"></i><span>Home</span></a><div class=icon><a aria-label=home href=/ id=go-home><i class="ri-home-6-line ri-xl"></i></a><a aria-label="rss feed" href=/blog/feed.xml><i class="ri-rss-line ri-xl"></i></a><button aria-label="dark light mode switch" id=color-toggle><i class="ri-moon-line ri-xl"></i></button><button aria-label="table of content" id=toc-toggle><i class="ri-menu-2-line ri-xl"></i></button></div></div><div id=progress-bar></div></header><div class=wrap><div class=blank></div><main><div id=top></div><article><h1>Virtual machines: configure, share and automate</h1><div id=post-info><div class=date><span id=publish>2023-07-31</span></div><div class=tags><a class=tag href=https://edibotopic.com/tags/how-to><i class="ri-hashtag ri-sm"></i><span>how-to</span></a><a class=tag href=https://edibotopic.com/tags/virtualisation><i class="ri-hashtag ri-sm"></i><span>virtualisation</span></a><a class=tag href=https://edibotopic.com/tags/ansible><i class="ri-hashtag ri-sm"></i><span>Ansible</span></a><a class=tag href=https://edibotopic.com/tags/software><i class="ri-hashtag ri-sm"></i><span>software</span></a></div></div><p>Creating and using virtual machines is pretty easy with Vagrant, VirtualBox and Ansible.</p><span id=continue-reading></span><h1 id=introduction>Introduction</h1><p>This how-to will explain how to use <a rel="nofollow noreferrer" href=https://www.vagrantup.com/>Vagrant</a>, <a rel="nofollow noreferrer" href=https://www.virtualbox.org/>VirtualBox</a> and <a rel="nofollow noreferrer" href=https://www.ansible.com/>Ansible</a> to create and manage a virtual machine (VM) on Linux.<p>After reading, you will be able to run a command that generates a VM that shares files with your computer and comes with a game pre-installed.<h1 id=install-vagrant>Install Vagrant</h1><p>Vagrant makes the process of setting up and managing VMs quick and painless. On a Debian-based distribution — like Ubuntu — run the following commands to install:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>wget</span><span> https://releases.hashicorp.com/vagrant/2.2.19/vagrant_2.2.19_x86_64.deb
</span><span style=color:#50fa7b>sudo</span><span> apt install ./vagrant_2.2.19_x86_64.deb
</span><span style=color:#50fa7b>vagrant</span><span style=font-style:italic;color:#ffb86c> --version </span><span style=color:#6272a4># Vagrant 2.2.19
</span></code></pre><h1 id=install-virtualbox>Install VirtualBox</h1><p>VirtualBox will provide the virtual environments that Vagrant initialises and configures:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>sudo</span><span> apt install virtualbox
</span></code></pre><h1 id=install-ansible>Install Ansible</h1><p>Ansible will enable automation of tasks in the VM. It can be run on the host or guest machine. If it is to be run on the host it will need to be installed first.<p>The <a rel="nofollow noreferrer" href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html>Ansible documentation</a> states that a regular <code>pip install</code> may not work and this was true for me on Ubuntu. In this is the case, first install <code>pipx</code> before invoking it to install Ansible as follows:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>python3</span><span style=font-style:italic;color:#ffb86c> -m</span><span> pip install</span><span style=font-style:italic;color:#ffb86c> --user</span><span> pipx
</span><span style=color:#50fa7b>pipx</span><span style=font-style:italic;color:#ffb86c> --version
</span><span style=color:#50fa7b>pipx</span><span> install</span><span style=font-style:italic;color:#ffb86c> --include-deps</span><span> ansible
</span></code></pre><h1 id=create-a-vm>Create a VM</h1><p>To set up a VM first create some directories to organise your VM(s). The VMs on my computer are kept in <code>/vagrant_projects/</code>. I will be using <a rel="nofollow noreferrer" href=https://www.centos.org/>CentOS</a> for this test project so the working directory is named <code>/centOS_test/</code>.<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>mkdir</span><span> vagrant_projects </span><span style=color:#ff79c6>&& </span><span style=color:#8be9fd>cd</span><span> vagrant_projects
</span><span style=color:#50fa7b>mkdir</span><span> centOS_test </span><span style=color:#ff79c6>&& </span><span style=color:#8be9fd>cd</span><span> centOS_test
</span></code></pre><p>Running the following commands will first initialise a Vagrant environment, generating a <code>Vagrantfile</code>, and then create the CentOS VM according to the configuration specified in that file.<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>vagrant</span><span> init generic/centos7
</span><span style=color:#50fa7b>vagrant</span><span> up
</span></code></pre><p>Note that the <code>generic/centos7</code> is one of many "Vagrant Boxes" that can be found at the link below:<p><a rel="nofollow noreferrer" href=https://app.vagrantup.com/boxes/search>https://app.vagrantup.com/boxes/search</a><h1 id=run-the-vm>Run the VM</h1><p>To use the VM run Vagrants's <code>ssh</code> command and a centos7 prompt should appear:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>vagrant</span><span> ssh
</span><span style=color:#6272a4># [vagrant@centos7 ~]$
</span></code></pre><p>It should now be possible to update packages using the default package manager YUM:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#6272a4># [vagrant@centos7 ~]$
</span><span style=color:#50fa7b>yum</span><span> update
</span></code></pre><p>Python is installed by default and should work right away:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#6272a4># [vagrant@centos7 ~]$
</span><span style=color:#8be9fd>echo </span><span style=color:#f1fa8c>"print(2+3)" </span><span style=color:#ff79c6>></span><span> test.py
</span><span style=color:#50fa7b>ls </span><span style=color:#6272a4># test.py
</span><span style=color:#50fa7b>python</span><span> test.py </span><span style=color:#6272a4># prints 5
</span></code></pre><p>You can also install additional packages like the classic text adventure <a rel="nofollow noreferrer" href=https://en.wikipedia.org/wiki/Zork>Zork</a>. <em>This task will later be automated using Ansible.</em><pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#6272a4># [vagrant@centos7 ~]$
</span><span style=color:#50fa7b>sudo</span><span> yum install zork
</span><span style=color:#50fa7b>zork
</span><span>
</span><span style=color:#6272a4># Welcome to Dungeon.			This version created 11-MAR-91.
</span><span style=color:#6272a4># You are in an open field west of a big white house with a boarded
</span><span style=color:#6272a4># front door.
</span><span style=color:#6272a4># There is a small mailbox here.
</span></code></pre><p>If you have trouble using regular terminal commands like <code>clear</code> then you might need to change the active terminal type. This was the case with my default <code>Kitty</code> terminal but was easily resolved with:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#6272a4># [vagrant@centos7 ~]$
</span><span style=color:#fff>TERM</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>xterm-256color
</span></code></pre><h1 id=exit-and-destroy>Exit and Destroy</h1><p>To exit CentOS press <strong>&LTctrl></strong>+<strong>&LTD></strong> or type <code>exit</code> and press <strong>&LTreturn></strong>. The VM can be re-entered at any time from the vagrant environment using <code>vagrant ssh</code>. The state upon exiting will be preserved, including any installed packages and saved files.<p>If you want to destroy the VM to free up space on your host machine then run <code>vagrant destroy</code> after exiting the VM.<p>Note, that the <code>Vagrantfile</code> will remain in the <code>/centOS_test/</code> directory. This means that if you <code>cd</code> into that vagrant environment and run <code>vagrant up</code> you will again create the VM according to the configuration <code>Vagrantfile</code> specifies.<h1 id=configure-the-vm-with-vagrant>Configure the VM with Vagrant</h1><p>Each time <code>vagrant up</code> is run the VM is created according to the configuration specified in the <code>Vagrantfile</code>. By default this file is documented with helpful comments that explain several useful configuration options.<p>For the purpose of this article the configuration will be modified to achieve two basic things:<ol><li><strong>Share</strong> files between the host and guest in a dedicated folder<li><strong>Automate</strong> a YUM package installation with Ansible</ol><h1 id=share-between-guest-and-host>Share between guest and host</h1><p>This is an example of the current directory structure on the host machine:<pre class=language-tree data-lang=tree style=background:#282a36;color:#f8f8f2><code class=language-tree data-lang=tree><span>vagrant_projects
</span><span>├── centOS_test
</span><span>│   └── Vagrantfile
</span><span>└── shared
</span><span>    └── hello.md
</span></code></pre><p>I created a <code>shared</code> folder containing a markdown file with a basic greeting. To access this file in the virtual machine add the following line to <code>Vagrantfile</code>:<pre class=language-ruby data-lang=ruby style=background:#282a36;color:#f8f8f2><code class=language-ruby data-lang=ruby><span style=color:#6272a4># Vagrantfile
</span><span>config</span><span style=color:#ff79c6>.</span><span>vm</span><span style=color:#ff79c6>.</span><span>synced_folder </span><span style=color:#f1fa8c>"../shared/"</span><span>, </span><span style=color:#f1fa8c>"/home/vagrant/shared_data"
</span></code></pre><p>The first argument string is the relative path to the shared folder on the host machine. The second argument is the name of the shared folder that will be placed in the home directory in the virtual machine.<p>Run <code>vagrant up</code>, check that you are in the home directory and display its contents:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#6272a4># [vagrant@centos7 ~]$
</span><span style=color:#8be9fd>pwd </span><span style=color:#6272a4># /home/vagrant/
</span><span style=color:#50fa7b>ls </span><span style=color:#6272a4># shared_data
</span><span style=color:#50fa7b>cat</span><span> shared_data/hello.md </span><span style=color:#6272a4># Hello from the host machine!!!
</span></code></pre><p>Still in the VM, change the name of the file and edit its contents in <code>Vim</code>. The changes you make in the file should be reflected in the <code>/shared/</code> folder on your host machine.<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#6272a4># [vagrant@centos7 ~]$
</span><span style=color:#50fa7b>mv</span><span> shared_data/hello.md shared_data/zorkNotes.md
</span><span style=color:#50fa7b>vim</span><span> shared_data/zorkNotes
</span><span style=color:#6272a4># write notes on zork and save with :wq
</span><span style=color:#6272a4># this will update the file on host
</span></code></pre><p>If the VM is later destroyed and recreated the contents of the file will remain as they will be shared from the host.<h1 id=automate-with-ansible>Automate with Ansible</h1><p>If there is a specific task that needs to be run each time that the VM is created Ansible will help.<p>In <code>centOS_test</code> create <code>playbook.yml</code> and reference it in <code>Vagrantfile</code>:<pre class=language-ruby data-lang=ruby style=background:#282a36;color:#f8f8f2><code class=language-ruby data-lang=ruby><span style=color:#6272a4># Vagrantfile
</span><span>config</span><span style=color:#ff79c6>.</span><span>vm</span><span style=color:#ff79c6>.</span><span>provision </span><span style=color:#f1fa8c>"ansible" </span><span style=color:#ff79c6>do </span><span>|</span><span style=font-style:italic;color:#ffb86c>ansible</span><span>|
</span><span>  ansible</span><span style=color:#ff79c6>.</span><span>playbook </span><span style=color:#ff79c6>= </span><span style=color:#f1fa8c>"playbook.yml"
</span><span style=color:#ff79c6>end
</span></code></pre><p>Imagine you want a VM specifically for the purpose of playing Zork but you want to destroy the VM after each game to free up space on your computer. For convenience, you want Zork to be automatically installed every time you (re)create that VM.<p>In <code>playbook.yml</code> a task is defined that checks if a <strong>YUM</strong> package with the <strong>NAME</strong> Zork is <strong>PRESENT</strong> in the VM. When the user logs in to the VM, it will <strong>BECOME</strong> a user with <code>sudo</code> privileges. If the package <em>is not</em> present it will be sudo installed using yum. If it <em>is</em> installed then no installation will be performed. This is the playbook:<pre class=language-yml data-lang=yml style=background:#282a36;color:#f8f8f2><code class=language-yml data-lang=yml><span style=color:#6272a4># playbook.yml
</span><span>---
</span><span>- </span><span style=color:#ff79c6>name</span><span>: </span><span style=color:#f1fa8c>Testing Ansible Automation with Zork
</span><span>  </span><span style=color:#ff79c6>hosts</span><span>: </span><span style=color:#f1fa8c>all
</span><span>  </span><span style=color:#ff79c6>become</span><span>: </span><span style=color:#bd93f9>yes
</span><span>  </span><span style=color:#ff79c6>tasks</span><span>:
</span><span>    - </span><span style=color:#ff79c6>name</span><span>: </span><span style=color:#f1fa8c>Ensure Zork is installed
</span><span>      </span><span style=color:#ff79c6>yum</span><span>: </span><span style=color:#f1fa8c>name=zork state=present
</span></code></pre><p>After <code>vagrant up</code> is run check if Zork has been automatically installed:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#50fa7b>which</span><span> zork </span><span style=color:#6272a4># /usr/bin/zork
</span></code></pre><p>Success! You can run <code>zork</code> and start playing:<pre class=language-bash data-lang=bash style=background:#282a36;color:#f8f8f2><code class=language-bash data-lang=bash><span style=color:#6272a4># [vagrant@centos7 ~]$
</span><span style=color:#6272a4># You are in an open field west of a big white house with a boarded
</span><span style=color:#6272a4># front door.
</span><span style=color:#6272a4># There is a small mailbox here.
</span><span style=color:#6272a4># > mailbox
</span><span style=color:#6272a4># What should I do with the mailbox?
</span><span style=color:#6272a4># > open
</span><span style=color:#6272a4># Opening the mailbox reveals:
</span><span style=color:#6272a4># A leaflet.
</span><span style=color:#6272a4># > leaflet
</span><span style=color:#6272a4># What should I do with the leaflet?
</span><span style=color:#6272a4># > take
</span><span style=color:#6272a4># Taken.
</span><span style=color:#6272a4># > eat leaflet
</span><span style=color:#6272a4># I don't think that the leaflet would agree with you.
</span><span style=color:#6272a4># > take
</span><span style=color:#6272a4># You already have it.
</span><span style=color:#6272a4># ...
</span></code></pre><p>Dispose of the VM as usual with <code>vagrant destroy</code>.<p>Both <code>playbook.yml</code> and <code>Vagrantfile</code> still remain in the <code>/centOS_test/</code> directory. Each time <code>vagrant up</code> is run subsequently the VM will be created with the shared folder and with Zork pre-installed.</article></main><aside class=blur><nav><ul><li><a class=toc-h2 href=#introduction>Introduction</a><li><a class=toc-h2 href=#install-vagrant>Install Vagrant</a><li><a class=toc-h2 href=#install-virtualbox>Install VirtualBox</a><li><a class=toc-h2 href=#install-ansible>Install Ansible</a><li><a class=toc-h2 href=#create-a-vm>Create a VM</a><li><a class=toc-h2 href=#run-the-vm>Run the VM</a><li><a class=toc-h2 href=#exit-and-destroy>Exit and Destroy</a><li><a class=toc-h2 href=#configure-the-vm-with-vagrant>Configure the VM with Vagrant</a><li><a class=toc-h2 href=#share-between-guest-and-host>Share between guest and host</a><li><a class=toc-h2 href=#automate-with-ansible>Automate with Ansible</a></ul></nav><a aria-label="back to top" href=#top id=back-to-top><i class="ri-arrow-up-s-line ri-2x"></i></a></aside></div><footer><div class=copyright>Copyright © 2023 edibotopic.</div></footer><script src=/js/dark.js></script><script src=/js/toc.js></script><script src=/js/progress.js></script><script src=/js/lightense.min.js></script><script src=/js/img.js></script>